// ================================
// BARCODE SCANNER - VERS√ÉO CORRIGIDA
// Vers√£o simplificada e robusta para resolver problemas de inicializa√ß√£o
// ================================

class BarcodeScanner {
    constructor() {
        this.isScanning = false;
        this.videoStream = null;
        this.quaggaInitialized = false;
        this.onBarcodeDetected = null;
        
        // Bind methods to preserve context
        this.handleBarcodeDetection = this.handleBarcodeDetection.bind(this);
        this.handleError = this.handleError.bind(this);
    }

    /**
     * Iniciar scanner - m√©todo principal
     */
    async startScanning(onDetected) {
        console.log('üöÄ Iniciando scanner...');
        
        if (this.isScanning) {
            console.log('‚ö†Ô∏è Scanner j√° est√° ativo');
            return;
        }

        this.onBarcodeDetected = onDetected;

        try {
            // Verificar se Quagga est√° dispon√≠vel
            if (typeof Quagga === 'undefined') {
                throw new Error('QuaggaJS n√£o est√° carregado. Verifique se a biblioteca est√° inclu√≠da.');
            }

            // Verificar suporte √† c√¢mera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('C√¢mera n√£o suportada neste navegador');
            }

            // Mostrar modal
            const modal = document.getElementById('scanner-modal');
            if (!modal) {
                throw new Error('Modal do scanner n√£o encontrado. Verifique se o HTML est√° correto.');
            }
            modal.classList.add('active');

            // Iniciar c√¢mera
            await this.initCamera();
            
            // Inicializar Quagga
            await this.initQuagga();
            
            this.isScanning = true;
            console.log('‚úÖ Scanner iniciado com sucesso');
            
            // Atualizar status na UI
            this.updateScannerStatus('üì± Posicione o c√≥digo de barras no quadro');

        } catch (error) {
            console.error('‚ùå Erro ao iniciar scanner:', error);
            this.handleError(error.message);
            this.stopScanning();
        }
    }

    /**
     * Inicializar c√¢mera com fallbacks
     */
    async initCamera() {
        console.log('üìπ Inicializando c√¢mera...');
        
        const video = document.getElementById('scanner-video');
        if (!video) {
            throw new Error('Elemento de v√≠deo n√£o encontrado');
        }

        // Configura√ß√µes da c√¢mera com fallbacks
        const constraints = {
            video: {
                facingMode: 'environment', // C√¢mera traseira
                width: { ideal: 1280, min: 640 },
                height: { ideal: 720, min: 480 }
            }
        };

        try {
            // Tentar com c√¢mera traseira primeiro
            console.log('üì± Tentando c√¢mera traseira...');
            this.videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (envError) {
            console.log('üì± C√¢mera traseira falhou, tentando qualquer c√¢mera...');
            try {
                // Fallback: qualquer c√¢mera dispon√≠vel
                constraints.video = { width: { ideal: 640 }, height: { ideal: 480 } };
                this.videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (anyError) {
                throw new Error(`Falha ao acessar c√¢mera: ${anyError.message}`);
            }
        }

        // Configurar elemento de v√≠deo
        video.srcObject = this.videoStream;
        
        // Aguardar v√≠deo carregar
        await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
                reject(new Error('Timeout ao carregar v√≠deo'));
            }, 5000);
            
            video.onloadedmetadata = () => {
                clearTimeout(timeout);
                console.log(`üìπ V√≠deo carregado: ${video.videoWidth}x${video.videoHeight}`);
                resolve();
            };
            
            video.onerror = () => {
                clearTimeout(timeout);
                reject(new Error('Erro ao carregar v√≠deo'));
            };
        });
    }

    /**
     * Inicializar Quagga com configura√ß√£o otimizada
     */
    async initQuagga() {
        return new Promise((resolve, reject) => {
            console.log('üîç Inicializando detector Quagga...');
            
            const config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-video'),
                    constraints: {
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 },
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        "ean_reader",      // EAN-13, EAN-8
                        "upc_reader",      // UPC-A
                        "upc_e_reader",    // UPC-E  
                        "code_128_reader", // Code 128
                        "code_39_reader"   // Code 39
                    ],
                    debug: {
                        drawBoundingBox: false,
                        showFrequency: false,
                        drawScanline: false,
                        showPattern: false
                    }
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 1,
                frequency: 20
            };

            Quagga.init(config, (err) => {
                if (err) {
                    console.error('‚ùå Erro ao inicializar Quagga:', err);
                    reject(new Error(`Falha na inicializa√ß√£o do scanner: ${err.message}`));
                    return;
                }

                console.log('‚úÖ Quagga inicializado');
                
                // Configurar listeners
                Quagga.onDetected(this.handleBarcodeDetection);
                
                // Iniciar detec√ß√£o
                Quagga.start();
                this.quaggaInitialized = true;
                
                resolve();
            });
        });
    }

    /**
     * Lidar com detec√ß√£o de c√≥digo de barras
     */
    handleBarcodeDetection(result) {
        const code = result.codeResult.code;
        console.log('üîç C√≥digo detectado:', code);
        
        // Atualizar status
        this.updateScannerStatus(`üîç C√≥digo detectado: ${code}`);
        
        // Validar c√≥digo
        if (this.isValidBarcode(code)) {
            console.log('‚úÖ C√≥digo v√°lido:', code);
            
            // Mostrar sucesso
            this.updateScannerStatus(`‚úÖ C√≥digo v√°lido: ${code}`);
            
            // Parar scanner ap√≥s delay
            setTimeout(() => {
                this.stopScanning();
                
                // Chamar callback
                if (this.onBarcodeDetected) {
                    this.onBarcodeDetected(code);
                }
            }, 1000);
            
        } else {
            console.log('‚ùå C√≥digo inv√°lido, continuando...', code);
            this.updateScannerStatus('‚ùå C√≥digo inv√°lido, tentando novamente...');
            
            // Resetar status ap√≥s delay
            setTimeout(() => {
                this.updateScannerStatus('üì± Posicione o c√≥digo de barras no quadro');
            }, 2000);
        }
    }

    /**
     * Validar c√≥digo de barras
     */
    isValidBarcode(code) {
        if (!code || typeof code !== 'string') return false;
        
        const cleanCode = code.trim();
        const digitCount = (cleanCode.match(/\d/g) || []).length;
        const totalLength = cleanCode.length;
        
        // Deve ter pelo menos 50% d√≠gitos
        if (digitCount < totalLength * 0.5) return false;
        
        // Valida√ß√£o de comprimento
        if (totalLength < 6 || totalLength > 18) return false;
        
        // Padr√µes comuns
        const patterns = [
            /^\d{8}$/,          // EAN-8
            /^\d{12}$/,         // UPC-A
            /^\d{13}$/,         // EAN-13
            /^[\dA-Z\-\. ]+$/   // Code 39/128
        ];
        
        return patterns.some(pattern => pattern.test(cleanCode));
    }

    /**
     * Atualizar status na interface
     */
    updateScannerStatus(message) {
        const statusElement = document.getElementById('scanner-status');
        const hintElement = statusElement?.querySelector('.scanner-hint');
        
        if (hintElement) {
            hintElement.textContent = message;
        } else {
            console.log('Scanner Status:', message);
        }
    }

    /**
     * Parar scanner
     */
    stopScanning() {
        console.log('üõë Parando scanner...');
        
        // Esconder modal
        const modal = document.getElementById('scanner-modal');
        if (modal) {
            modal.classList.remove('active');
        }

        // Parar Quagga
        if (this.quaggaInitialized) {
            try {
                Quagga.stop();
                Quagga.offDetected(this.handleBarcodeDetection);
                this.quaggaInitialized = false;
                console.log('‚úÖ Quagga parado');
            } catch (error) {
                console.error('‚ùå Erro ao parar Quagga:', error);
            }
        }

        // Parar stream de v√≠deo
        if (this.videoStream) {
            this.videoStream.getTracks().forEach(track => {
                track.stop();
            });
            this.videoStream = null;
            console.log('‚úÖ Stream de v√≠deo parado');
        }

        this.isScanning = false;
        this.onBarcodeDetected = null;
        
        console.log('‚úÖ Scanner parado completamente');
    }

    /**
     * Lidar com erros
     */
    handleError(message) {
        console.error('‚ùå Erro do scanner:', message);
        
        // Mostrar erro via toast se dispon√≠vel
        if (typeof showToast === 'function') {
            showToast(`‚ùå ${message}`, 'error');
        } else {
            alert(`Erro do Scanner: ${message}`);
        }
    }

    /**
     * Entrada manual como fallback
     */
    promptManualInput() {
        const barcode = prompt('Digite o c√≥digo de barras manualmente:');
        if (barcode && barcode.trim()) {
            const cleanBarcode = barcode.trim();
            console.log('‚úèÔ∏è C√≥digo manual:', cleanBarcode);
            if (this.onBarcodeDetected) {
                this.onBarcodeDetected(cleanBarcode);
            }
            return cleanBarcode;
        }
        return null;
    }

    /**
     * Verificar disponibilidade da c√¢mera
     */
    static async isCameraAvailable() {
        try {
            if (!navigator.mediaDevices?.getUserMedia) {
                return false;
            }
            const devices = await navigator.mediaDevices.enumerateDevices();
            return devices.some(device => device.kind === 'videoinput');
        } catch (error) {
            console.error('Erro ao verificar c√¢mera:', error);
            return false;
        }
    }
}

// ================================
// INST√ÇNCIA GLOBAL E FUN√á√ïES
// ================================

// Criar inst√¢ncia global
const barcodeScanner = new BarcodeScanner();

// Fun√ß√£o global para iniciar scanner
function startBarcodeScanner() {
    console.log('üöÄ Iniciando scanner via fun√ß√£o global...');
    
    barcodeScanner.startScanning((barcode) => {
        console.log('üìä Resultado do scanner:', barcode);
        
        // Chamar fun√ß√£o de resultado se existir
        if (typeof handleBarcodeResult === 'function') {
            handleBarcodeResult(barcode);
        }
        
        // Mostrar toast se dispon√≠vel
        if (typeof showToast === 'function') {
            showToast(`‚úÖ C√≥digo escaneado: ${barcode}`, 'success');
        } else {
            console.log(`‚úÖ C√≥digo escaneado: ${barcode}`);
        }
    }).catch(error => {
        console.error('‚ùå Erro fatal do scanner:', error);
        if (typeof showToast === 'function') {
            showToast(`‚ùå Erro: ${error.message}`, 'error');
        }
    });
}

// Fun√ß√£o global para parar scanner
function stopBarcodeScanner() {
    barcodeScanner.stopScanning();
}

// Fun√ß√£o global para entrada manual
function manualBarcodeInput() {
    barcodeScanner.stopScanning();
    const barcode = barcodeScanner.promptManualInput();
    if (barcode && typeof handleBarcodeResult === 'function') {
        handleBarcodeResult(barcode);
    }
}

// Fun√ß√£o para verificar se tudo est√° funcionando
function testScannerSetup() {
    console.log('üß™ Testando configura√ß√£o do scanner...');
    
    const checks = {
        quagga: typeof Quagga !== 'undefined',
        camera: !!navigator.mediaDevices?.getUserMedia,
        modal: !!document.getElementById('scanner-modal'),
        video: !!document.getElementById('scanner-video')
    };
    
    console.log('üìã Verifica√ß√µes:', checks);
    
    const allOk = Object.values(checks).every(check => check);
    
    if (allOk) {
        console.log('‚úÖ Tudo configurado corretamente!');
        if (typeof showToast === 'function') {
            showToast('‚úÖ Scanner configurado corretamente', 'success');
        }
    } else {
        const missing = Object.entries(checks)
            .filter(([_, value]) => !value)
            .map(([key, _]) => key);
        console.error('‚ùå Problemas encontrados:', missing);
        if (typeof showToast === 'function') {
            showToast(`‚ùå Problemas: ${missing.join(', ')}`, 'error');
        }
    }
    
    return allOk;
}

// Fun√ß√£o de fallback para handleBarcodeResult se n√£o existir
function handleBarcodeResult(barcode) {
    console.log('üìä C√≥digo recebido:', barcode);
    
    // Se existe um elemento de input com id 'barcode', preencher
    const barcodeInput = document.getElementById('barcode');
    if (barcodeInput) {
        barcodeInput.value = barcode;
        console.log('‚úÖ C√≥digo inserido no campo de entrada');
    }
}

// Auto-teste quando carregar
document.addEventListener('DOMContentLoaded', () => {
    console.log('üîß Scanner carregado, executando auto-teste...');
    setTimeout(testScannerSetup, 1000);
});

console.log('üéØ Scanner de c√≥digo de barras carregado - Vers√£o Corrigida v1.0');