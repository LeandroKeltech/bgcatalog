// ================================
// SCANNER EAN OTIMIZADO
// Vers√£o especializada para c√≥digos EAN-13 e EAN-8
// ================================

class EANBarcodeScanner {
    constructor() {
        this.isScanning = false;
        this.videoStream = null;
        this.quaggaInitialized = false;
        this.onBarcodeDetected = null;
        this.detectionHistory = new Map(); // Para evitar duplicatas
        
        // Bind methods
        this.handleBarcodeDetection = this.handleBarcodeDetection.bind(this);
        this.handleError = this.handleError.bind(this);
    }

    /**
     * Iniciar scanner EAN otimizado
     */
    async startScanning(onDetected) {
        console.log('üéØ Iniciando scanner EAN otimizado...');
        
        if (this.isScanning) {
            console.log('‚ö†Ô∏è Scanner j√° est√° ativo');
            return;
        }

        this.onBarcodeDetected = onDetected;
        this.detectionHistory.clear();

        try {
            // Verifica√ß√µes b√°sicas
            if (typeof Quagga === 'undefined') {
                throw new Error('QuaggaJS n√£o est√° carregado');
            }

            if (!navigator.mediaDevices?.getUserMedia) {
                throw new Error('C√¢mera n√£o suportada neste navegador');
            }

            // Mostrar modal
            const modal = document.getElementById('scanner-modal');
            if (!modal) {
                throw new Error('Modal do scanner n√£o encontrado');
            }
            modal.classList.add('active');

            // Iniciar c√¢mera com configura√ß√£o otimizada para EAN
            await this.initOptimizedCamera();
            
            // Inicializar Quagga com configura√ß√£o EAN
            await this.initEANQuagga();
            
            this.isScanning = true;
            console.log('‚úÖ Scanner EAN iniciado com sucesso');
            
            // Atualizar status
            this.updateScannerStatus('üì± Posicione o c√≥digo EAN no quadro');

        } catch (error) {
            console.error('‚ùå Erro ao iniciar scanner EAN:', error);
            this.handleError(error.message);
            this.stopScanning();
        }
    }

    /**
     * Inicializar c√¢mera com configura√ß√£o otimizada para EAN
     */
    async initOptimizedCamera() {
        console.log('üìπ Iniciando c√¢mera otimizada para EAN...');
        
        const video = document.getElementById('scanner-video');
        if (!video) {
            throw new Error('Elemento de v√≠deo n√£o encontrado');
        }

        // Configura√ß√µes otimizadas para leitura de EAN
        const constraints = {
            video: {
                facingMode: 'environment',
                width: { 
                    min: 800, 
                    ideal: 1280, 
                    max: 1920 
                },
                height: { 
                    min: 600, 
                    ideal: 720, 
                    max: 1080 
                },
                // Configura√ß√µes espec√≠ficas para melhor foco
                focusMode: 'continuous',
                exposureMode: 'continuous',
                whiteBalanceMode: 'continuous'
            }
        };

        try {
            // Tentar com c√¢mera traseira otimizada
            this.videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (envError) {
            console.log('üì± C√¢mera traseira falhou, usando fallback...');
            // Fallback com configura√ß√µes b√°sicas
            constraints.video = {
                facingMode: { ideal: 'environment' },
                width: { ideal: 1280 },
                height: { ideal: 720 }
            };
            this.videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        }

        // Configurar elemento de v√≠deo
        video.srcObject = this.videoStream;
        
        // Aguardar v√≠deo carregar
        await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
                reject(new Error('Timeout ao carregar v√≠deo'));
            }, 10000); // 10 segundos para carregamento
            
            video.onloadedmetadata = () => {
                clearTimeout(timeout);
                console.log(`üìπ V√≠deo EAN carregado: ${video.videoWidth}x${video.videoHeight}`);
                resolve();
            };
        });
    }

    /**
     * Inicializar Quagga com configura√ß√£o espec√≠fica para EAN
     */
    async initEANQuagga() {
        return new Promise((resolve, reject) => {
            console.log('üîç Inicializando detector EAN...');
            
            const config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-video'),
                    constraints: {
                        width: { min: 800, ideal: 1280, max: 1920 },
                        height: { min: 600, ideal: 720, max: 1080 },
                        facingMode: "environment"
                    }
                },
                decoder: {
                    // APENAS leitores EAN para m√°xima precis√£o
                    readers: [
                        "ean_reader",      // EAN-13 e EAN-8 (prioridade)
                        "upc_reader",      // UPC-A (compat√≠vel com EAN)
                        "upc_e_reader"     // UPC-E (compat√≠vel com EAN)
                    ],
                    debug: {
                        drawBoundingBox: true,   // Mostrar √°rea detectada
                        showFrequency: false,
                        drawScanline: true,      // Mostrar linha de scan
                        showPattern: false
                    }
                },
                locate: true,
                locator: {
                    patchSize: "large",      // Patches grandes para EAN
                    halfSample: false,       // M√°xima qualidade
                    showCanvas: false,
                    showPatches: false,
                    showFoundPatches: false,
                    showSkeleton: false,
                    showLabels: false,
                    showPatchLabels: false,
                    showRemainingPatchLabels: false,
                    boxFromPatches: {
                        showTransformed: false,
                        showTransformedBox: false,
                        showBB: false
                    }
                },
                numOfWorkers: 2,        // 2 workers para melhor performance
                frequency: 30,          // Alta frequ√™ncia para EAN
                area: {                 // √Årea focada no centro
                    top: "20%",
                    right: "20%", 
                    left: "20%",
                    bottom: "20%"
                }
            };

            Quagga.init(config, (err) => {
                if (err) {
                    console.error('‚ùå Erro ao inicializar Quagga EAN:', err);
                    reject(new Error(`Falha na inicializa√ß√£o EAN: ${err.message}`));
                    return;
                }

                console.log('‚úÖ Detector EAN inicializado');
                
                // Configurar listeners otimizados para EAN
                this.setupEANListeners();
                
                // Iniciar detec√ß√£o
                Quagga.start();
                this.quaggaInitialized = true;
                
                resolve();
            });
        });
    }

    /**
     * Configurar listeners espec√≠ficos para EAN
     */
    setupEANListeners() {
        // Listener principal para detec√ß√µes
        Quagga.onDetected((result) => {
            const code = result.codeResult.code;
            const format = result.codeResult.format;
            
            console.log(`üéØ EAN detectado: ${code} (${format})`);
            
            // Verificar se √© realmente EAN
            if (this.isEANFormat(format)) {
                this.handleEANDetection(code, result);
            }
        });

        // Listener para melhorar qualidade de detec√ß√£o
        Quagga.onProcessed((result) => {
            if (result && result.codeResult) {
                const code = result.codeResult.code;
                const format = result.codeResult.format;
                const quality = result.codeResult.quality;
                
                // Aceitar apenas detec√ß√µes de alta qualidade para EAN
                if (this.isEANFormat(format) && quality > 80) {
                    this.handleEANDetection(code, result);
                }
            }
        });
    }

    /**
     * Verificar se o formato √© EAN
     */
    isEANFormat(format) {
        const eanFormats = ['EAN_13', 'EAN_8', 'UPC_A', 'UPC_E'];
        return eanFormats.includes(format);
    }

    /**
     * Lidar com detec√ß√£o EAN
     */
    handleEANDetection(code, result) {
        const now = Date.now();
        const format = result.codeResult.format;
        
        // Evitar duplicatas recentes (√∫ltimos 2 segundos)
        if (this.detectionHistory.has(code)) {
            const lastDetection = this.detectionHistory.get(code);
            if (now - lastDetection < 2000) {
                return; // Ignorar duplicata recente
            }
        }
        
        // Atualizar hist√≥rico
        this.detectionHistory.set(code, now);
        
        // Atualizar status
        this.updateScannerStatus(`üîç EAN detectado: ${code} (${format})`);
        
        // Validar EAN
        if (this.isValidEAN(code)) {
            console.log('‚úÖ EAN v√°lido:', code);
            
            // Mostrar sucesso
            this.updateScannerStatus(`‚úÖ EAN v√°lido: ${code}`);
            
            // Som de sucesso (se suportado)
            this.playSuccessSound();
            
            // Parar scanner ap√≥s delay
            setTimeout(() => {
                this.stopScanning();
                
                // Chamar callback
                if (this.onBarcodeDetected) {
                    this.onBarcodeDetected(code);
                }
            }, 1200); // Delay maior para mostrar resultado
            
        } else {
            console.log('‚ùå EAN inv√°lido, continuando...', code);
            this.updateScannerStatus('‚ùå EAN inv√°lido, tentando novamente...');
            
            // Resetar status ap√≥s delay
            setTimeout(() => {
                this.updateScannerStatus('üì± Posicione o c√≥digo EAN no quadro');
            }, 2000);
        }
    }

    /**
     * Validar c√≥digo EAN especificamente
     */
    isValidEAN(code) {
        if (!code || typeof code !== 'string') return false;
        
        const cleanCode = code.trim();
        
        // EAN deve ser apenas d√≠gitos
        if (!/^\d+$/.test(cleanCode)) return false;
        
        // Validar comprimentos EAN
        if (cleanCode.length === 8) {
            return this.validateEAN8(cleanCode);
        } else if (cleanCode.length === 13) {
            return this.validateEAN13(cleanCode);
        } else if (cleanCode.length === 12) {
            // UPC-A (tratado como EAN-13 com zero √† esquerda)
            return this.validateEAN13('0' + cleanCode);
        } else if (cleanCode.length >= 6 && cleanCode.length <= 8) {
            // UPC-E (formato compacto)
            return true; // Aceitar UPC-E sem valida√ß√£o checksum complexa
        }
        
        return false;
    }

    /**
     * Validar checksum EAN-8
     */
    validateEAN8(code) {
        const digits = code.split('').map(Number);
        const checksum = digits.pop();
        
        let sum = 0;
        for (let i = 0; i < digits.length; i++) {
            sum += digits[i] * (i % 2 === 0 ? 3 : 1);
        }
        
        const calculatedChecksum = (10 - (sum % 10)) % 10;
        return calculatedChecksum === checksum;
    }

    /**
     * Validar checksum EAN-13
     */
    validateEAN13(code) {
        const digits = code.split('').map(Number);
        const checksum = digits.pop();
        
        let sum = 0;
        for (let i = 0; i < digits.length; i++) {
            sum += digits[i] * (i % 2 === 0 ? 1 : 3);
        }
        
        const calculatedChecksum = (10 - (sum % 10)) % 10;
        return calculatedChecksum === checksum;
    }

    /**
     * Som de sucesso
     */
    playSuccessSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Som espec√≠fico para EAN (dois bips)
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.08);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
            
        } catch (error) {
            console.log('üîä Som de sucesso EAN');
        }
    }

    /**
     * Atualizar status na interface
     */
    updateScannerStatus(message) {
        const statusElement = document.getElementById('scanner-status');
        const hintElement = statusElement?.querySelector('.scanner-hint');
        
        if (hintElement) {
            hintElement.textContent = message;
        }
        
        console.log('üì± Status:', message);
    }

    /**
     * Parar scanner
     */
    stopScanning() {
        console.log('üõë Parando scanner EAN...');
        
        // Esconder modal
        const modal = document.getElementById('scanner-modal');
        if (modal) {
            modal.classList.remove('active');
        }

        // Parar Quagga
        if (this.quaggaInitialized) {
            try {
                Quagga.stop();
                Quagga.offDetected();
                Quagga.offProcessed();
                this.quaggaInitialized = false;
                console.log('‚úÖ Quagga EAN parado');
            } catch (error) {
                console.error('‚ùå Erro ao parar Quagga:', error);
            }
        }

        // Parar stream de v√≠deo
        if (this.videoStream) {
            this.videoStream.getTracks().forEach(track => {
                track.stop();
            });
            this.videoStream = null;
            console.log('‚úÖ Stream EAN parado');
        }

        this.isScanning = false;
        this.onBarcodeDetected = null;
        this.detectionHistory.clear();
        
        console.log('‚úÖ Scanner EAN parado completamente');
    }

    /**
     * Lidar com erros
     */
    handleError(message) {
        console.error('‚ùå Erro do scanner EAN:', message);
        
        if (typeof showToast === 'function') {
            showToast(`‚ùå ${message}`, 'error');
        } else {
            alert(`Erro do Scanner EAN: ${message}`);
        }
    }

    /**
     * Entrada manual para EAN
     */
    promptManualEAN() {
        const barcode = prompt('Digite o c√≥digo EAN (8 ou 13 d√≠gitos):');
        if (barcode && barcode.trim()) {
            const cleanBarcode = barcode.trim().replace(/\D/g, ''); // Apenas d√≠gitos
            
            if (this.isValidEAN(cleanBarcode)) {
                console.log('‚úèÔ∏è EAN manual v√°lido:', cleanBarcode);
                if (this.onBarcodeDetected) {
                    this.onBarcodeDetected(cleanBarcode);
                }
                return cleanBarcode;
            } else {
                alert('C√≥digo EAN inv√°lido! Digite apenas 8 ou 13 d√≠gitos.');
                return this.promptManualEAN(); // Tentar novamente
            }
        }
        return null;
    }
}

// ================================
// INST√ÇNCIA GLOBAL E FUN√á√ïES PARA EAN
// ================================

// Criar inst√¢ncia global otimizada para EAN
const eanBarcodeScanner = new EANBarcodeScanner();

// Fun√ß√£o global para iniciar scanner EAN
function startEANScanner() {
    console.log('üéØ Iniciando scanner EAN via fun√ß√£o global...');
    
    eanBarcodeScanner.startScanning((barcode) => {
        console.log('üìä EAN detectado:', barcode);
        
        // Chamar fun√ß√£o de resultado se existir
        if (typeof handleBarcodeResult === 'function') {
            handleBarcodeResult(barcode);
        }
        
        // Mostrar toast se dispon√≠vel
        if (typeof showToast === 'function') {
            showToast(`‚úÖ EAN escaneado: ${barcode}`, 'success');
        }
    });
}

// Substituir fun√ß√£o global padr√£o para usar EAN
function startBarcodeScanner() {
    startEANScanner();
}

// Fun√ß√£o global para parar scanner EAN
function stopBarcodeScanner() {
    eanBarcodeScanner.stopScanning();
}

// Fun√ß√£o global para entrada manual EAN
function manualBarcodeInput() {
    eanBarcodeScanner.stopScanning();
    const barcode = eanBarcodeScanner.promptManualEAN();
    if (barcode && typeof handleBarcodeResult === 'function') {
        handleBarcodeResult(barcode);
    }
}

console.log('üéØ Scanner EAN Otimizado carregado - v1.0');