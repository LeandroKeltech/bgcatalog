{% extends 'catalog/base.html' %}

{% block title %}{% if is_edit %}Edit{% else %}Add{% endif %} Game - Board Game Catalog{% endblock %}

{% block content %}
<h1 class="mb-4">
    <i class="bi bi-{% if is_edit %}pencil{% else %}plus-circle{% endif %}"></i>
    {% if is_edit %}Edit{% else %}Add{% endif %} Board Game
</h1>

<form method="post">
    {% csrf_token %}
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Game Information</h5>
                </div>
                <div class="card-body">
                    {% if game_data.thumbnail_url %}
                        <div class="text-center mb-3">
                            <img src="{{ game_data.thumbnail_url }}" alt="{{ game_data.name }}" class="img-thumbnail" style="max-height: 200px;">
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Game Name *</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ game_data.name }}" required readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="year_published" class="form-label">Year Published</label>
                        <input type="number" class="form-control" id="year_published" name="year_published" 
                               value="{{ game_data.year_published }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="designer" class="form-label">Designer</label>
                        <input type="text" class="form-control" id="designer" name="designer" 
                               value="{{ game_data.designer }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="5">{{ game_data.description }}</textarea>
                    </div>
                    
                    {% if game_data.min_players or game_data.max_players %}
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Min Players</label>
                                <input type="number" class="form-control" value="{{ game_data.min_players }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Max Players</label>
                                <input type="number" class="form-control" value="{{ game_data.max_players }}" readonly>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if game_data.min_playtime or game_data.max_playtime %}
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Min Playtime</label>
                                <input type="number" class="form-control" value="{{ game_data.min_playtime }}" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Max Playtime</label>
                                <input type="number" class="form-control" value="{{ game_data.max_playtime }}" readonly>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-md-6">
            <!-- Price Info from Multiple Sources -->
            {% if game_data.price_sources %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-currency-euro"></i> Available Prices (Ireland/EU)</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3"><strong>Found {{ game_data.price_sources|length }} price source(s). Click to select:</strong></p>
                    
                    <div class="list-group">
                        {% for price in game_data.price_sources %}
                        <a href="#" class="list-group-item list-group-item-action price-option" 
                           data-price="{{ price.price_eur }}"
                           data-source="{{ price.source }}"
                           data-store="{{ price.store_name }}"
                           data-url="{{ price.store_url }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">
                                    <span class="badge bg-success">€{{ price.price_eur }}</span>
                                    {{ price.source }}
                                </h5>
                                <small class="text-muted">
                                    {% if price.currency_original != 'EUR' %}
                                        ({{ price.currency_original }} {{ price.price_original }})
                                    {% endif %}
                                </small>
                            </div>
                            <p class="mb-1">
                                <i class="bi bi-shop"></i> <strong>{{ price.store_name }}</strong>
                                {% if price.stock_status == 'in_stock' %}
                                    <span class="badge bg-success">In Stock</span>
                                {% elif price.stock_status == 'preorder' %}
                                    <span class="badge bg-info">Pre-order</span>
                                {% elif price.stock_status == 'backorder' %}
                                    <span class="badge bg-warning">Backorder</span>
                                {% elif price.stock_status == 'oos' %}
                                    <span class="badge bg-danger">Out of Stock</span>
                                {% else %}
                                    <span class="badge bg-secondary">Stock Unknown</span>
                                {% endif %}
                                {% if price.shipping_to_ie %}
                                    <span class="badge bg-primary">Ships to IE</span>
                                {% elif price.shipping_to_ie == False %}
                                    <span class="badge bg-warning">No IE shipping</span>
                                {% endif %}
                            </p>
                            {% if price.game_name or price.game_year %}
                                <p class="mb-1 text-info">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Edition:</strong> 
                                    {% if price.game_name %}{{ price.game_name }}{% endif %}
                                    {% if price.game_year %} ({{ price.game_year }}){% endif %}
                                </p>
                            {% endif %}
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> Updated: {{ price.last_updated|slice:":10" }}
                                {% if price.notes %}
                                    <br><i class="bi bi-info-circle"></i> {{ price.notes }}
                                {% endif %}
                            </small>
                            {% if price.store_url %}
                                <a href="{{ price.store_url }}" target="_blank" class="btn btn-sm btn-outline-primary float-end" onclick="event.stopPropagation()">
                                    <i class="bi bi-box-arrow-up-right"></i> View Store
                                </a>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                    
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle"></i> 
                        <span id="selected-price-info">Click on a price to use it as MSRP</span>
                    </div>
                </div>
            </div>
            {% elif game_data.msrp_price %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-currency-euro"></i> Market Price (Ireland/EUR)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <strong>Price:</strong> €{{ game_data.msrp_price }}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-exclamation-triangle"></i> No Prices Found</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-info-circle"></i> No prices found for Ireland/EU. Please enter manually.
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Inventory & Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="condition" class="form-label">Condition *</label>
                        <select class="form-select" id="condition" name="condition" required onchange="updateDiscount()">
                            {% for cond_value, cond_label in condition_choices %}
                                <option value="{{ cond_value }}" {% if game.condition == cond_value %}selected{% endif %}>
                                    {{ cond_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="msrp_price" class="form-label">MSRP Price (€) *</label>
                        <input type="number" step="0.01" class="form-control" id="msrp_price" name="msrp_price" 
                               value="{% if game.msrp_price %}{{ game.msrp_price }}{% elif game_data.msrp_price %}{{ game_data.msrp_price }}{% endif %}" 
                               required onchange="calculateFinalPrice()">
                        <small class="form-text text-muted">
                            {% if game_data.msrp_price %}
                                Market price from BoardGamePrices: €{{ game_data.msrp_price }}
                            {% else %}
                                Original manufacturer's suggested retail price
                            {% endif %}
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="discount_percentage" class="form-label">Discount Percentage (%)</label>
                        <input type="number" step="0.01" class="form-control" id="discount_percentage" 
                               name="discount_percentage" 
                               value="{% if game.discount_percentage %}{{ game.discount_percentage }}{% elif game_data %}20.00{% endif %}" 
                               min="0" max="100" onchange="calculateFinalPrice()">
                        <small class="form-text text-muted">
                            Default: New (20%), Like New (30%), Used (50%), Damaged (70%), Missing Pieces (85%)
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="final_price_display" class="form-label">Final Price (€)</label>
                        <input type="text" class="form-control" id="final_price_display" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stock_quantity" class="form-label">Stock Quantity *</label>
                        <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" 
                               value="{% if game.stock_quantity %}{{ game.stock_quantity }}{% else %}1{% endif %}" 
                               min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Any additional notes about this game...">{% if game.notes %}{{ game.notes }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-check-circle"></i> {% if is_edit %}Update{% else %}Add to Catalog{% endif %}
                </button>
                <a href="{% if is_edit %}{% url 'game_detail' game.pk %}{% else %}{% url 'catalog_list' %}{% endif %}" 
                   class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
    // Discount defaults based on condition
    const discountDefaults = {
        'new': 20.00,
        'like_new': 30.00,
        'used': 50.00,
        'damaged': 70.00,
        'missing_pieces': 85.00
    };
    
    function updateDiscount() {
        const condition = document.getElementById('condition').value;
        const discountInput = document.getElementById('discount_percentage');
        
        if (condition in discountDefaults) {
            discountInput.value = discountDefaults[condition];
            calculateFinalPrice();
        }
    }
    
    function calculateFinalPrice() {
        const msrpPrice = parseFloat(document.getElementById('msrp_price').value) || 0;
        const discountPercentage = parseFloat(document.getElementById('discount_percentage').value) || 0;
        
        const discountAmount = msrpPrice * (discountPercentage / 100);
        const finalPrice = msrpPrice - discountAmount;
        
        document.getElementById('final_price_display').value = finalPrice.toFixed(2);
    }
    
    // Price selection from multiple sources
    document.addEventListener('DOMContentLoaded', function() {
        calculateFinalPrice();
        
        // Add click handlers for price options
        document.querySelectorAll('.price-option').forEach(function(option) {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get price data
                const price = parseFloat(this.dataset.price);
                const source = this.dataset.source;
                const store = this.dataset.store;
                
                // Update MSRP field
                document.getElementById('msrp_price').value = price.toFixed(2);
                
                // Update info message
                document.getElementById('selected-price-info').innerHTML = 
                    '<i class="bi bi-check-circle"></i> Selected: €' + price.toFixed(2) + 
                    ' from <strong>' + source + '</strong> (' + store + ')';
                
                // Highlight selected option
                document.querySelectorAll('.price-option').forEach(function(opt) {
                    opt.classList.remove('active', 'list-group-item-success');
                });
                this.classList.add('active', 'list-group-item-success');
                
                // Recalculate final price
                calculateFinalPrice();
                
                // Minimize prices block and focus on inventory
                const pricesCard = document.querySelector('.card:has(.list-group)') || 
                                  document.querySelector('[class*="price"]:has(.list-group)').closest('.card');
                if (pricesCard) {
                    // Collapse the card body
                    const cardBody = pricesCard.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.style.maxHeight = '120px';
                        cardBody.style.overflow = 'hidden';
                        cardBody.style.transition = 'max-height 0.3s ease-out';
                        
                        // Add a "Show all prices" button
                        let showAllBtn = pricesCard.querySelector('.show-all-prices-btn');
                        if (!showAllBtn) {
                            showAllBtn = document.createElement('button');
                            showAllBtn.className = 'btn btn-sm btn-outline-secondary show-all-prices-btn mt-2';
                            showAllBtn.innerHTML = '<i class="bi bi-chevron-down"></i> Show all prices';
                            showAllBtn.type = 'button';
                            showAllBtn.addEventListener('click', function() {
                                if (cardBody.style.maxHeight === '120px') {
                                    cardBody.style.maxHeight = 'none';
                                    this.innerHTML = '<i class="bi bi-chevron-up"></i> Minimize prices';
                                } else {
                                    cardBody.style.maxHeight = '120px';
                                    this.innerHTML = '<i class="bi bi-chevron-down"></i> Show all prices';
                                }
                            });
                            cardBody.appendChild(showAllBtn);
                        }
                    }
                }
                
                // Focus on inventory pricing section
                const inventoryCard = document.querySelector('.card:has(#condition)') || 
                                     document.querySelector('h5:contains("Inventory")').closest('.card');
                if (inventoryCard) {
                    inventoryCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    // Add a subtle highlight animation
                    inventoryCard.style.boxShadow = '0 0 15px rgba(0,123,255,0.3)';
                    inventoryCard.style.transition = 'box-shadow 0.5s ease-out';
                    setTimeout(() => {
                        inventoryCard.style.boxShadow = '';
                    }, 2000);
                }
            });
        });
    });
</script>
{% endblock %}
